@model Web_day_tieng_Anh.Models.Question

@{
    ViewData["Title"] = "Update";
}

<h1>Update</h1>

<h4>Question</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form id="updateForm" asp-action="Update" asp-controller="Questions" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="QuestionId" />
            <input type="hidden" asp-for="TestId" />

            <div class="form-group">
                <label asp-for="QuestionContent" class="control-label"></label>
                <textarea id="QuestionContent" name="QuestionContent" class="form-control">@Html.Raw(Model.QuestionContent.Replace("<p>", "").Replace("</p>", ""))</textarea>
                <span asp-validation-for="QuestionContent" class="text-danger"></span>
            </div>

            @if (Model.Answers != null)
            {
                for (int i = 0; i < Model.Answers.Count; i++)
                {
                    <div class="form-group">
                        <label for="Answers_@(i)__AnswerContent" class="control-label">Answer @(char.ConvertFromUtf32(65 + i))</label>
                        <input id="Answers_@(i)__AnswerContent" name="Answers[@i].AnswerContent" class="form-control" value="@Html.Raw(Model.Answers[i].AnswerContent)" />
                        <input type="hidden" id="Answers_@(i)__IsCorrect" name="Answers[@i].IsCorrect" value="@Model.Answers[i].IsCorrect" />
                        <input type="checkbox" name="Answers[@i].IsCorrect" @(Model.Answers[i].IsCorrect ? "checked" : "") value="true" /> Correct
                    </div>
                }
            }
            else
            {
                for (int i = 0; i < 4; i++)
                {
                    <div class="form-group">
                        <label for="Answers_@(i)__AnswerContent" class="control-label">Answer @(char.ConvertFromUtf32(65 + i))</label>
                        <input id="Answers_@(i)__AnswerContent" name="Answers[@i].AnswerContent" class="form-control" />
                        <input type="hidden" id="Answers_@(i)__IsCorrect" name="Answers[@i].IsCorrect" value="false" />
                        <input type="checkbox" name="Answers[@i].IsCorrect" value="true" /> Correct
                    </div>
                }
            }

            <div class="form-group">
                <input type="submit" value="Save" onclick="saveUpdate()" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div class="mt-2 mb-2">
    <a asp-controller="Questions" asp-action="Index" asp-route-testId="@Model.TestId" class="btn btn-primary">Back</a>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("form#updateForm");

            if (form) {
                form.addEventListener("submit", function (event) {
                    event.preventDefault(); // Ngăn chặn form submit mặc định
                    saveUpdate(); // Gọi hàm để lưu cập nhật
                });
            }

            // Hàm lưu cập nhật
            function saveUpdate() {
                const questionId = document.querySelector("input[name='QuestionId']").value;
                const questionContent = document.getElementById("QuestionContent").value;
                const answers = [];

                // Lặp qua các câu trả lời và thu thập dữ liệu từ form
                for (let i = 0; i < 4; i++) {
                    const answerContent = document.getElementById(`Answers_${i}__AnswerContent`).value;
                    const isCorrect = document.getElementById(`Answers_${i}__IsCorrect`).checked;

                    answers.push({
                        answerContent: answerContent,
                        isCorrect: isCorrect
                    });
                }

                // Gửi dữ liệu đến server
                sendDataToServer(questionId, questionContent, answers);
            }

            // Hàm gửi dữ liệu đến server
            function sendDataToServer(questionId, questionContent, answers) {
                const xhr = new XMLHttpRequest();
                xhr.open("POST", form.action, true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        // Xử lý phản hồi từ server và chuyển hướng đến trang Index
                        window.location.href = `/Lecturers/Questions/Index?testId=${document.querySelector("input[name='TestId']").value}`;
                    }
                };
                const data = JSON.stringify({ questionId: questionId, questionContent: questionContent, answers: answers });
                xhr.send(data);
            }
        });
    </script>
}

